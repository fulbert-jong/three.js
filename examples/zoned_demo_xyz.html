<!DOCTYPE html>
<html lang="en">
	<head>
		<title>zone demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>

	<body>
		<div id="info">
		<!-- <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - XYZ loader<br/> -->
		<!-- asset from <a href="https://people.math.sc.edu/Burkardt/data/xyz/xyz.html" target="_blank" rel="noopener">people.math.sc.edu</a> via GNU LGPL -->
		</div>

		<script type="module">

			import * as THREE from '../build/three.module.js';

			import { XYZLoader } from './jsm/loaders/XYZLoader.js';
			import { OrbitControls } from './jsm/controls/OrbitControls.js';

			let camera, controls, scene, renderer, clock;

			let points;
			let start_frame = 50;
			let end_frame = 61;
			let display_frames= end_frame - 1;
			let colorhex=0xf09729;
			let oldpoints;
			init();
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera.position.set( 11, -85, 180 );
				// camera.position.z = 100;
				scene = new THREE.Scene();
				scene.add( camera );
				camera.lookAt( scene.position );
				clock = new THREE.Clock();

				// Load all frames and keep them invisible except the displayed frame
				var iframe;
				let loader = new XYZLoader();
				for (iframe = start_frame; iframe < end_frame; iframe++) {
					synchronized_load(loader, iframe);
				}
				// Initialize WebGL
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );

				window.addEventListener( 'resize', onWindowResize, false );
				// Controls
				controls = new OrbitControls( camera, renderer.domElement );
				controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
				controls.dampingFactor = 0.1;

				// Lights
				var keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);
				keyLight.position.set(-100, 0, 100);

				var fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);
				fillLight.position.set(100, 0, 100);

				var backLight = new THREE.DirectionalLight(0xffffff, 1.0);
				backLight.position.set(100, 0, -100).normalize();
				
				scene.add(keyLight);
				scene.add(fillLight);
				scene.add(backLight);

				// Event Listerner for key press
				document.addEventListener("keypress", function(pressed){

					if (pressed.key == "n"){
						oldpoints = scene.getObjectByName( display_frames );
						display_frames++;
						points = scene.getObjectByName( display_frames );
						points.visible=true;
						oldpoints.visible=false;
						console.log("frame: " + display_frames)
						return;
					} else if (pressed.key == "p"){
						oldpoints = scene.getObjectByName( display_frames );
						display_frames--;
						points = scene.getObjectByName( display_frames );
						points.visible=true;
						oldpoints.visible=false;
						console.log("frame: " + display_frames)
						return;
					} else if (pressed.key == "h"){
						points = scene.getObjectByName( display_frames );
						points.visible=false;
						return;
					} else if (pressed.key == "u"){
						points = scene.getObjectByName( display_frames );
						points.visible=true;
						return;
					} else if (pressed.key == "l"){
						console.log(camera.position)
					} else{
						return;
					}
				});
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				const delta = clock.getDelta();

				renderer.render( scene, camera );

			}

			function xyz_load(loader, iframe, iframe2) {
				loader.load( 'models/xyz/PCL_frame_' + iframe + 'fixed_div_by_50_YZflip.xyz', function ( geometry ) {
					geometry.center();
					const vertexColors = ( geometry.hasAttribute( 'color' ) === true );
					const material = new THREE.PointsMaterial( { size: 0.1, vertexColors: false, color: colorhex });
					points = new THREE.Points( geometry, material );
					points.name=iframe;
					scene.add( points );
					if (iframe == display_frames){
						return;
					}
					points.visible=false;
					} );
			}
			async function synchronized_load(loader, iframe, iframe2){
				var x = await xyz_load(loader, iframe, iframe2);
			}
		</script>

	</body>
</html>
